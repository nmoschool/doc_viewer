<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>مستعرض مستندات مدرسة تحفيظ القرآن بالبجادية</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700;800&display=swap" rel="stylesheet" />

    <style>
      :root {
        --gold: #d4a853;
        --navy: #0a1628;
        --navy-light: #152238;
        --bg-color: #f4f7f6;
        --panel-bg: #ffffff;
        --text-color: #0a1628;
        --border-color: #eee;
        --shadow: 0 4px 15px rgba(0,0,0,0.1);
      }

      body.dark-mode {
        --bg-color: #050a12;
        --panel-bg: #111b2d;
        --text-color: #e0e0e0;
        --navy: #020811;
        --navy-light: #0a1628;
        --border-color: #1f2d44;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; transition: background 0.3s, color 0.3s; }

      body {
        font-family: 'Almarai', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      header {
        background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
        color: var(--gold);
        padding: 15px;
        text-align: center;
        border-bottom: 4px solid var(--gold);
        position: relative;
        flex-shrink: 0;
      }

      .theme-toggle {
        position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
        background: rgba(212, 168, 83, 0.2); border: 1px solid var(--gold);
        color: var(--gold); padding: 8px; border-radius: 50%; cursor: pointer;
        z-index: 100;
      }

      .main-wrapper {
        display: flex; flex: 1; gap: 20px; padding: 20px;
        max-width: 1400px; margin: 0 auto; width: 100%;
        overflow: hidden;
      }

      .sidebar {
        width: 350px; background: var(--panel-bg); border-radius: 12px;
        box-shadow: var(--shadow); display: flex; flex-direction: column;
        flex-shrink: 0;
      }

      .sidebar-header {
        background: var(--navy); color: var(--gold); padding: 15px;
        border-radius: 12px 12px 0 0; font-weight: bold;
        display: flex; align-items: center; gap: 10px;
      }

      .fav-section { border-bottom: 3px solid var(--gold); background: rgba(212, 168, 83, 0.05); max-height: 40%; overflow-y: auto; }

      .search-box { padding: 10px; background: var(--border-color); }
      #search-input {
        width: 100%; padding: 10px; border: 1px solid var(--gold);
        border-radius: 8px; background: var(--panel-bg); color: var(--text-color);
      }

      .file-list-container { overflow-y: auto; padding: 10px; flex: 1; }

      .folder-item {
        background: var(--border-color); margin-bottom: 5px; cursor: pointer;
        padding: 12px; border-radius: 8px; font-weight: bold;
        display: flex; justify-content: space-between; align-items: center;
      }

      .folder-content { display: none; padding-right: 5px; margin-bottom: 10px; }

      .file-item {
        padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
      }
      .file-item:hover { background: rgba(212, 168, 83, 0.1); }
      .file-item.active { background: var(--gold) !important; color: var(--navy) !important; font-weight: bold; }

      .star-icon { margin-right: auto; cursor: pointer; color: #ccc; transition: 0.2s; padding: 5px; }
      .star-icon.active { color: #f1c40f; }

      .viewer-area {
        flex: 1; background: var(--panel-bg); border-radius: 12px;
        box-shadow: var(--shadow); display: flex; flex-direction: column;
        overflow: hidden;
      }

      .viewer-toolbar {
        padding: 10px 15px; border-bottom: 2px solid var(--gold);
        display: flex; justify-content: space-between; align-items: center;
        background: var(--navy-light); color: white; flex-shrink: 0;
      }

      .toolbar-actions { display: flex; gap: 8px; }

      .btn-action {
        background: var(--gold); color: var(--navy); padding: 8px 12px;
        text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 0.8rem; border: none; cursor: pointer;
        display: flex; align-items: center; gap: 6px;
      }
      .btn-action:hover { background: #eec16a; }

      #display-container {
        flex: 1; display: flex; flex-direction: column; background: #525659;
        position: relative; overflow: hidden;
      }

      #viewer-frame { width: 100%; height: 100%; border: none; flex: 1; }

      @media (max-width: 992px) {
        body { overflow: auto; }
        .main-wrapper { flex-direction: column; height: auto; overflow: visible; padding: 10px; }
        .sidebar { width: 100%; max-height: 400px; }
        .viewer-area { height: 75vh; min-height: 500px; }
        .btn-action span { display: none; } /* إخفاء النص في الجوال لإبقاء الأيقونة فقط */
      }
    </style>
</head>
<body>

    <header>
      <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
      <h1>مدرسة تحفيظ القرآن بالبجادية</h1>
      <p style="font-size: 0.8rem; opacity: 0.8;">المنصة التعليمية الشاملة | NMO</p>
    </header>

    <div class="main-wrapper">
      <aside class="sidebar">
        <div id="favorites-section" class="fav-section" style="display: none;">
          <div class="sidebar-header" style="background: #f1c40f; color: #000;">
            <i class="fas fa-star"></i> ملفاتي المفضلة
          </div>
          <div id="favorites-list"></div>
        </div>

        <div class="sidebar-header"><i class="fas fa-folder-open"></i> الفصول الدراسية</div>
        <div class="search-box">
          <input type="text" id="search-input" placeholder="ابحث عن كتاب أو ملف..." onkeyup="filterFiles()">
        </div>
        <div class="file-list-container" id="file-list">
          <p style="text-align:center; padding:20px;">جاري جلب الملفات...</p>
        </div>
      </aside>

      <main class="viewer-area">
        <div class="viewer-toolbar">
          <div id="file-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 45%;">اختر ملفاً</div>
          <div class="toolbar-actions">
            <button class="btn-action" onclick="goFullScreen()" title="ملء الشاشة">
                <i class="fas fa-expand"></i>
            </button>
            <button id="share-btn" class="btn-action" style="display:none;" onclick="shareLink()" title="مشاركة الرابط">
                <i class="fas fa-link"></i> <span>مشاركة</span>
            </button>
            <a href="#" id="download-link" class="btn-action" style="display:none;" target="_blank" title="تحميل الملف">
                <i class="fas fa-download"></i> <span>تحميل</span>
            </a>
          </div>
        </div>
        <div id="display-container">
          <div id="placeholder" style="color: white; text-align: center; margin: auto; padding: 20px;">
            <i class="fas fa-book-open" style="font-size: 3.5rem; color: var(--gold); margin-bottom: 15px; display: block;"></i>
            الرجاء اختيار مستند من القائمة للبدء
          </div>
        </div>
      </main>
    </div>

    <script>
      const username = "nmoschool";
      const repo = "doc_viewer";
      const folderPath = "documents";
      const classFolders = ["جداول الاختبارات", "أول ابتدائي", "ثاني ابتدائي", "ثالث ابتدائي", "رابع ابتدائي", "خامس ابتدائي", "سادس ابتدائي"];
      
      let favorites = JSON.parse(localStorage.getItem('nmo_favs')) || [];
      let currentURL = "";

      async function init() {
        renderFavorites();
        const listDiv = document.getElementById('file-list');
        
        let data = JSON.parse(sessionStorage.getItem('nmo_cache'));
        if (!data) {
          try {
            const promises = classFolders.map(f => 
              fetch(`https://api.github.com/repos/${username}/${repo}/contents/${folderPath}/${encodeURIComponent(f)}`)
              .then(r => r.json()).then(files => ({folder: f, files: Array.isArray(files) ? files : []}))
              .catch(() => ({folder: f, files: []}))
            );
            data = await Promise.all(promises);
            sessionStorage.setItem('nmo_cache', JSON.stringify(data));
          } catch(e) {
            listDiv.innerHTML = '<p style="text-align:center; padding:20px;">فشل الاتصال بالخادم</p>';
            return;
          }
        }

        let html = '';
        data.forEach(({folder, files}) => {
          if (files.length > 0) {
            html += `<div class="folder-item" onclick="toggleFolder(this)"><span><i class="fas fa-folder"></i> ${folder}</span><i class="fas fa-chevron-down"></i></div><div class="folder-content">`;
            files.forEach(file => {
              const isFav = favorites.some(fav => fav.path === `${folder}/${file.name}`);
              html += `
                <div class="file-item" onclick="loadFile('${file.name}', '${folder}/${file.name}', this)">
                  <i class="${getIcon(file.name)}"></i>
                  <span style="flex:1">${file.name.split('.').shift()}</span>
                  <i class="fas fa-star star-icon ${isFav?'active':''}" onclick="toggleFav('${file.name}', '${folder}/${file.name}', event)"></i>
                </div>`;
            });
            html += `</div>`;
          }
        });
        listDiv.innerHTML = html;
        if (localStorage.getItem('dark') === '1') toggleTheme(true);
      }

      function getIcon(n) {
        const e = n.split('.').pop().toLowerCase();
        if(e==='pdf') return 'fas fa-file-pdf text-danger';
        if(['doc','docx'].includes(e)) return 'fas fa-file-word text-primary';
        if(['xls','xlsx'].includes(e)) return 'fas fa-file-excel text-success';
        return 'fas fa-file-alt';
      }

      function toggleFolder(el) {
        const c = el.nextElementSibling;
        const isOpen = c.style.display === 'block';
        c.style.display = isOpen ? 'none' : 'block';
        el.querySelector('.fa-chevron-down').style.transform = isOpen ? '' : 'rotate(180deg)';
      }

      function loadFile(name, path, el) {
        document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
        if(el) el.classList.add('active');
        
        document.getElementById('file-title').innerText = name;
        
        // الرابط المطلق للملف على GitHub Pages
        const absoluteURL = `https://${username}.github.io/${repo}/${folderPath}/${encodeURIComponent(path)}`;
        currentURL = absoluteURL;

        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const ext = name.split('.').pop().toLowerCase();
        const container = document.getElementById('display-container');
        
        // تفعيل أزرار التحميل والمشاركة
        const dl = document.getElementById('download-link');
        const sh = document.getElementById('share-btn');
        dl.style.display = 'flex';
        dl.href = absoluteURL;
        sh.style.display = 'flex';

        if (ext === 'pdf') {
          if (isMobile) {
            // استخدام عارض جوجل للموبايل لضمان عدم التحميل التلقائي
            const gViewer = `https://docs.google.com/viewer?url=${encodeURIComponent(absoluteURL)}&embedded=true`;
            container.innerHTML = `<iframe id="viewer-frame" src="${gViewer}" style="background:white;"></iframe>`;
          } else {
            // استخدام العارض المدمج للكمبيوتر
            container.innerHTML = `<embed src="${absoluteURL}" type="application/pdf" id="viewer-frame">`;
          }
        } else if (['doc','docx','xls','xlsx','ppt','pptx'].includes(ext)) {
          // عارض أوفيس أونلاين
          container.innerHTML = `<iframe id="viewer-frame" src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(absoluteURL)}"></iframe>`;
        } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
          container.innerHTML = `<div style="height:100%; display:flex; align-items:center; justify-content:center; background:#333;"><img src="${absoluteURL}" style="max-width:95%; max-height:95%; object-fit:contain;"></div>`;
        } else {
          container.innerHTML = `<div style="color:white; text-align:center; margin:auto;"><i class="fas fa-file-alt" style="font-size:3rem;"></i><p>المعاينة غير متاحة لهذا الملف.</p></div>`;
        }
      }

      function toggleFav(name, path, e) {
        e.stopPropagation();
        const idx = favorites.findIndex(f => f.path === path);
        if (idx > -1) favorites.splice(idx, 1);
        else favorites.push({name, path});
        localStorage.setItem('nmo_favs', JSON.stringify(favorites));
        renderFavorites();
        init();
      }

      function renderFavorites() {
        const section = document.getElementById('favorites-section');
        const list = document.getElementById('favorites-list');
        if (favorites.length === 0) { section.style.display = 'none'; return; }
        
        section.style.display = 'block';
        list.innerHTML = favorites.map(f => `
          <div class="file-item" style="background: var(--panel-bg)" onclick="loadFile('${f.name}', '${f.path}', null)">
            <i class="fas fa-star" style="color:#f1c40f"></i>
            <span style="flex:1">${f.name.split('.').shift()}</span>
            <i class="fas fa-trash-alt" style="color:#ccc; font-size: 0.8rem;" onclick="toggleFav('${f.name}', '${f.path}', event)"></i>
          </div>
        `).join('');
      }

      function goFullScreen() {
        const elem = document.getElementById("display-container");
        if (elem.requestFullscreen) elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
      }

      function filterFiles() {
        const t = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('.file-list-container .file-item').forEach(f => {
          const match = f.innerText.toLowerCase().includes(t);
          f.style.display = match ? 'flex' : 'none';
          if(match && t) f.parentElement.style.display = 'block';
        });
      }

      function shareLink() {
        if(!currentURL) return;
        navigator.clipboard.writeText(currentURL).then(() => {
            alert("✅ تم نسخ رابط الملف المباشر!");
        });
      }

      function toggleTheme(initOnly = false) {
        if (!initOnly) document.body.classList.toggle('dark-mode');
        else if (localStorage.getItem('dark') === '1') document.body.classList.add('dark-mode');
        localStorage.setItem('dark', document.body.classList.contains('dark-mode') ? '1' : '0');
        const icon = document.querySelector('.theme-toggle i');
        icon.className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon';
      }

      init();
    </script>
</body>
</html>
